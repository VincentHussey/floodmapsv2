{% extends "base_template.html" %}

{% block title %}Map Viewer{% endblock %}
{% block header %}
    <link href="/static/detail.css" rel="stylesheet" type="text/css" >
    <script src="/static/js/ext-3.4.0/adapter/ext/ext-base.js" type="text/javascript"></script>
    <script src="/static/js/ext-3.4.0/ext-all.js"  type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="/static/js/ext-3.4.0/resources/css/ext-all.css">
    <script src="/static/js/OpenLayers-2.12/OpenLayers.js" type="text/javascript"></script>
    <script src="/static/js/GeoExt/lib/GeoExt.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="/static/js/GeoExt/resources/css/geoext-all-debug.css">

    
<script type="text/javascript">
        var WebMercator = new OpenLayers.Projection("EPSG:3857");
        var WGS84 = new OpenLayers.Projection("EPSG:4326");
        var ING = new OpenLayers.Projection("EPSG:29903");
        var ITM = new OpenLayers.Projection("EPSG:2157");
        var bounds_WM = new OpenLayers.Bounds(-1200000, 6800000, -420000, 7250000);
        var bounds_WGS84 = new OpenLayers.Bounds(-12, 53, 4, 58);
        
        var mapPanel, tree, treeConfig, dataStore, wmsStore, gridPanel, mainPanel;
        
        treeConfig = [{nodeType: "gx_baselayercontainer"},
                    {nodeType: "gx_overlaylayercontainer",expanded: true}
        ];
        

    Ext.onReady(function() {
        OpenLayers.IMAGE_RELOAD_ATTEMPTS = 3;
        OpenLayers.Util.onImageLoadErrorColor = "transparent"; 
        var controls = [new OpenLayers.Control.Navigation(), new OpenLayers.Control.PanZoomBar(),
                        //new OpenLayers.Control.NavigationHistory(), new OpenLayers.Control.LayerSwitcher(),
                        new OpenLayers.Control.ScaleLine(), new OpenLayers.Control.Scale($('scale')),
                        new OpenLayers.Control.MousePosition({element: $('location')})
                        ];
        var options = {
                //numZoomLevels: 14,
                controls: controls,
                //maxExtent: bounds_WGS84, //bounds_WM,
                //resolutions: [1000,352.645,176.32242,74.0542,52.896723,35.26448,26.448362,17.632241,8.816121,3.526448,1.763224,0.881612,0.352645],
                projection: WebMercator,
                displayProjection: WGS84,
                units: 'm'
            };
        var map = new OpenLayers.Map(options);
        var osm = new OpenLayers.Layer.OSM();
        var mapfile = '/opt/projects/floodmapsv2/floodmapsv2/floodmapsv2/mapserv.map';
        var wms_server = '/cgi-bin/mapserv?map='+mapfile;
        var fl_1pc_aep_cs = new OpenLayers.Layer.WMS(
            '1% AEP Fluvial', wms_server,
            {
                //SERVICE: 'WMS', VERSION: '1.1.1', REQUEST: 'GetMap',
                srs: WebMercator,
                transparent: true,
                layers: 'Flood_extents_1pc_AEP',
                format: "image/png"
            },
            {isBaseLayer: false, visibility: false, opacity: 0.3}
        );
        
        var apsr = new OpenLayers.Layer.WMS(
            'APSR', wms_server,
            {
                //SERVICE: 'WMS', VERSION: '1.1.1', REQUEST: 'GetMap',
                srs: WebMercator,
                transparent: true,
                layers: 'apsr',
                format: "image/png"
            },
            {isBaseLayer: false, opacity: 0.5 }
        );
        
        //map.addLayer(layer);
        
    var apsr_wfs = new OpenLayers.Layer.Vector("apsr wfs", {
        strategies: [new OpenLayers.Strategy.BBOX()],
        protocol: new OpenLayers.Protocol.WFS({
            url:  wms_server,
            featureType: "apsr"//,
            //featureNS: "http://www.openplans.org/topp"
        })
    });
    
    var wmsLayer = new OpenLayers.Layer.WMS(
        "vmap0",
        "http://vmap0.tiles.osgeo.org/wms/vmap0",
        {layers: 'basic'}
    );
    

    
    // create vector layer
    var vecLayer = new OpenLayers.Layer.Vector("vector");
    
    map.addLayers([osm, vecLayer, apsr, fl_1pc_aep_cs]);

    // create map panel
    mapPanel = new GeoExt.MapPanel({
        //title: "Map Viewer",
        region: "center",
        height: 400,
        width: 600,
        map: map,
        center: new OpenLayers.LonLat(5, 45),
        zoom: 6
    });

    // create feature store, binding it to the vector layer
    store = new GeoExt.data.FeatureStore({
        layer: vecLayer,
        fields: [
            {name: 'name', type: 'string'},
            {name: 'elevation', type: 'float'}
        ],
        proxy: new GeoExt.data.ProtocolProxy({
            protocol: new OpenLayers.Protocol.HTTP({
                url: "/static/summits.json",
                format: new OpenLayers.Format.GeoJSON()
            })
        }),
        autoLoad: true
    });

    // create grid panel configured with feature store
    gridPanel = new Ext.grid.GridPanel({
        //title: "Feature Grid",
        region: "east",
        store: store,
        width: 320,
        columns: [{
            header: "Name",
            width: 200,
            dataIndex: "name"
        }, {
            header: "Elevation",
            width: 100,
            dataIndex: "elevation"
        }],
        sm: new GeoExt.grid.FeatureSelectionModel() 
    });
    
    tree = new Ext.tree.TreePanel({
        region: "west",
        root: new GeoExt.tree.LayerContainer({
            text: 'Map Layers',
            layerStore: mapPanel.layers,
            leaf: false,
            expanded: true
        }),
        enableDD: true,
        width: 170,
        height: 300,
        floating: true,
        x: 380,
        y: 0
    });
    
    // create a panel and add the map panel and grid panel
    // inside it
    mainPanel = new Ext.Panel({
        renderTo: "mainpanel",
        layout: "border",
        height: 600,
        //width: 900,
        items: [mapPanel, gridPanel, tree]
    });

        


    //map.zoomToExtent(bounds_WGS84);
    map.zoomToExtent(bounds_WM);
        //alert(wms_server);
    });
</script>
{% endblock %}
{% block menu-bar %}
    {% include "header.html" %}
    {% include "menu-bar.html" %}
    <span id="map_link" class="menubar"><a href="">Resize</a></span>
    </div>
{% endblock %}

{% block page_body %}
<div id="mainpanel"></div>
<div id="scale"></div>
<div id="location"></div>
{% endblock %}
